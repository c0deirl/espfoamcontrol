#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <ESP32Encoder.h>
#include "esp32-hal-ledc.h" // Add this line for PWM functions

// WiFi credentials
const char* ssid = "SurgeFX";
const char* password = "password";

// Pin definitions
#define MOTOR_PIN1 26  // H-Bridge input 1
#define MOTOR_PIN2 27  // H-Bridge input 2
#define MOTOR_EN 14    // H-Bridge enable pin
#define ENCODER_A 32   // Rotary encoder pin A
#define ENCODER_B 33   // Rotary encoder pin B
#define ENCODER_BTN 25   // Rotary encoder button pin

// OLED display configuration
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1  // Reset pin # (or -1 if sharing Arduino reset pin)
#define SCREEN_ADDRESS 0x3C

// PWM configuration
#define PWM_CHANNEL 0
#define PWM_FREQ 5000
#define PWM_RESOLUTION 8

// Initialize objects
WebServer server(80);
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
ESP32Encoder encoder;

// Global variables
int speedValue = 0;
bool updateDisplay = true;
int lastSpeedValue = 0;
bool lastButtonState = HIGH;

// HTML webpage
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>SurgeFX Foam Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <style>
        body { font-family: Arial, sans-serif; background:rgb(46, 46, 46); color: #222; margin: 0; padding: 0;}
        .container { max-width: 400px; margin: 40px auto; background:rgb(46, 46, 46); border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 24px;}
        h1 { text-align: center; margin-bottom: 0.5em; color:rgb(235, 133, 37);}
        .reading { font-size: 1.4em; margin: 1em 0; color:rgb(230, 230, 230); text-align: center;}
        .label { font-weight: bold; margin-bottom: 8px; color:rgb(230, 230, 230); display: block;}
        .form-group { margin: 16px 0; text-align: center;}
        input[type="number"] { width: 80px; padding: 0.5em; margin-right: 8px;}

	.slidecontainer {
	width: 100%; /* Width of the outside container */
	}
	
	/* The slider itself */
	.slider {
	-webkit-appearance: none;  /* Override default CSS styles */
	appearance: none;
	width: 100%; /* Full-width */
	height: 50px; /* Specified height */
	background: #d3d3d3; /* Grey background */
	outline: none; /* Remove outline */
	opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
	-webkit-transition: .2s; /* 0.2 seconds transition on hover */
	transition: opacity .2s;
	}

	/* Mouse-over effects */
	.slider:hover {
	opacity: 1; /* Fully shown on mouse-over */
	}

	/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
	.slider::-webkit-slider-thumb {
	-webkit-appearance: none; /* Override default look */
	appearance: none;
	width: 35px; /* Set a specific slider handle width */
	height: 50px; /* Slider handle height */
	background: #04AA6D; /* Green background */
	cursor: pointer; /* Cursor on hover */
	}

	.slider::-moz-range-thumb {
	width: 35px; /* Set a specific slider handle width */
	height: 50px; /* Slider handle height */
	background: #04AA6D; /* Green background */
	cursor: pointer; /* Cursor on hover */
	}
        .duration-btns button {
          background: #2563eb;
          color: #fff;
          border: none;
          border-radius: 4px;
          padding: 10px 22px;
          margin: 0 5px;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
        .duration-btns button.selected, .duration-btns button:hover {
          background: rgb(11, 38, 114);
		  
        }
        .submit-btn {
          margin-top: 18px;
          background: #059669;
          color: #fff;
          border: none;
          border-radius: 4px;
          padding: 10px 28px;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
		a:link, a:visited {
			
			color: white;
			
			text-align: center;
			text-decoration: none;
			}

			a:hover, a:active {
			background-color: red;
			}
        .submit-btn:hover { background: #047857;}
        .status { margin-top: 18px; text-align: center;}
        .footer { margin-top: 32px; text-align: center; font-size: 0.95em; color: #888;}
      </style>
  
</head>
<body>
  <div class="container">
  <h1>SurgeFX Foam Control</h1>
  <div class="reading">
  <div class="slidecontainer">
  <input type="range" min="0" max="250" value="0" class="slider" step="10" id="speedSlider" list="ticks">
  <datalist id="ticks">
    <option value="50"></option>
    <option value="100"></option>
    <option value="150"></option>
    <option value="250"></option>
  </datalist>
  </div>
    <p>Speed: <span id="speedValue">0</span></p>
  </div>
  <script>
    var slider = document.getElementById("speedSlider");
    var output = document.getElementById("speedValue");
    slider.oninput = function() {
      output.innerHTML = this.value;
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/speed?value=" + this.value, true);
      xhr.send();
    }
    setInterval(function() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          slider.value = this.responseText;
          output.innerHTML = this.responseText;
        }
      };
      xhr.open("GET", "/getSpeed", true);
      xhr.send();
    }, 1000);
  </script>
   <div class="footer">SurgeFX &copy; 2025</div>
  </div>
</body>
</html>
)rawliteral";

void setup() {
  Serial.begin(115200);
  
  // Define the boot logo
  // SurgeFX_bmp 64x64px
const unsigned char SurgeFX_bmp [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x1c, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xd8, 0x38, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfc, 0x70, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0xff, 0xe1, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x0f, 0xc7, 0xc3, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xf0, 0xb9, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf2, 0x23, 0x03, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x90, 0xc6, 0x06, 0x0f, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x41, 0x8c, 0x0c, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0xdb, 0x18, 0x18, 0x1b, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0x26, 0x38, 0x30, 0x34, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3a, 0x4f, 0x38, 0x62, 0x23, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x74, 0x07, 0x30, 0xc4, 0x46, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe8, 0x0e, 0x61, 0x88, 0x8c, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe9, 0x1c, 0xc3, 0x18, 0x8c, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xd0, 0x39, 0x86, 0x31, 0x07, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xa1, 0x73, 0x8c, 0x72, 0x0f, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xa2, 0x33, 0x98, 0xe4, 0x1b, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0x44, 0x77, 0xb1, 0xcc, 0x1f, 0x17, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xc8, 0x67, 0x63, 0x88, 0x1e, 0x0b, 0xff, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xcf, 0xfb, 0x87, 0x3f, 0xe7, 0xfe, 0xff, 0xb9, 0xb8, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xdf, 0xf7, 0x87, 0x3f, 0xe7, 0xfe, 0xff, 0xa3, 0xb0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xdc, 0x07, 0x87, 0x70, 0x66, 0x00, 0xe0, 0x26, 0xb0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xdf, 0xf7, 0x06, 0x78, 0xee, 0x7e, 0xfe, 0x00, 0x30, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xcf, 0xfb, 0x0e, 0x7f, 0xee, 0x0c, 0xc0, 0x3f, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xc0, 0x7e, 0x0e, 0x77, 0x8e, 0x0d, 0xc0, 0x3f, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0x1f, 0xf7, 0xfc, 0xf3, 0x8f, 0xfd, 0xff, 0x30, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0e, 0x7f, 0xf7, 0xfc, 0x73, 0x8f, 0xf9, 0xff, 0x30, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x1c, 0xff, 0xe3, 0xfc, 0x61, 0x8f, 0xf0, 0xfe, 0x30, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x40, 0xa1, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x1f, 0xfe, 0x02, 0xc0, 0x02, 0x0c, 0x64, 0xe1, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x38, 0x03, 0x8c, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0xcf, 0xec, 0xfc, 0xc7, 0x1c, 0x8f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x46, 0xc8, 0xf9, 0x8f, 0x3b, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xa9, 0xc9, 0xf3, 0x1e, 0x3e, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xb0, 0xd3, 0xc6, 0x1f, 0x1c, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xd1, 0xb3, 0x8c, 0x0f, 0x38, 0x5c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xeb, 0x27, 0x98, 0x0f, 0xf0, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x47, 0x30, 0x1e, 0xe0, 0xb8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x4e, 0x60, 0x39, 0xc1, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1a, 0xc8, 0xc0, 0x71, 0x82, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0x99, 0x81, 0xe3, 0x45, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x33, 0x03, 0xc6, 0x1b, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x26, 0x07, 0x88, 0x67, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x0c, 0x0e, 0x11, 0x9e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x1b, 0x0c, 0x06, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x3c, 0xfc, 0x79, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x7f, 0xbf, 0xc7, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0xe1, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x67, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Initialize OLED display
  if(!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    Serial.println(F("SSD1306 allocation failed"));
    for(;;); // Don't proceed, loop forever
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.drawBitmap(0, 0, SurgeFX_bmp, 128, 64, WHITE);
  display.display();

  // Initialize encoder
  encoder.attachHalfQuad(ENCODER_A, ENCODER_B);
  encoder.setCount(0);
  
  // Initialize motor pins
  pinMode(MOTOR_PIN1, OUTPUT);
  pinMode(MOTOR_PIN2, OUTPUT);
  pinMode(MOTOR_EN, OUTPUT);
  pinMode(ENCODER_BTN, INPUT_PULLUP);

    // Start the Wifi Access Point
    // Remove if using an existing WiFi
  WiFi.softAP(ssid, password);

  // Display IP on OLED
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("IP:");
  display.println(WiFi.softAPIP());
  display.display();
  
  // Setup web server routes
  server.on("/", HTTP_GET, []() {
    server.send(200, "text/html", index_html);
  });
  
  server.on("/speed", HTTP_GET, []() {
    if (server.hasArg("value")) {
      speedValue = server.arg("value").toInt();
      updateMotor();
      updateDisplay = true;
    }
    server.send(200, "text/plain", "OK");
  });
  
  server.on("/getSpeed", HTTP_GET, []() {
    server.send(200, "text/plain", String(speedValue));
  });
  
  server.begin();
}

// Alternative PWM method
void updateMotor() {
  if (speedValue > 0) {
    digitalWrite(MOTOR_PIN1, LOW);
    digitalWrite(MOTOR_PIN2, HIGH);
    analogWrite(MOTOR_EN, speedValue);  // Using analogWrite instead of ledcWrite
  } else {
    digitalWrite(MOTOR_PIN1, LOW);
    digitalWrite(MOTOR_PIN2, LOW);
    analogWrite(MOTOR_EN, 0);
  }
}

void updateOLED() {
  display.clearDisplay();
  
  // Display IP address
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("IP:");
  display.println(WiFi.softAPIP());
  
  // Display speed value
  display.setCursor(0, 28);
  display.print("Speed: ");
  display.println(speedValue);
  
  // Draw a progress bar
  int barWidth = map(speedValue, 0, 255, 0, SCREEN_WIDTH - 4);
  display.drawRect(0, 50, SCREEN_WIDTH - 2, 10, SSD1306_WHITE);
  display.fillRect(2, 52, barWidth, 6, SSD1306_WHITE);
  // Show status
  display.setCursor(0, 40);
  if (speedValue > 0) {
    display.print("Status: running");
  } else {
    display.print("Status: stopped");
  }
  display.display();
}

void loop() {
  server.handleClient();
  
  // Handle encoder
  static int lastCount = 0;
  int count = encoder.getCount();
  // Handle encoder button press to stop/start motor
  bool buttonState = digitalRead(ENCODER_BTN);
  if (lastButtonState == HIGH && buttonState == LOW) { // Button just pressed
    if (speedValue > 0) {
      lastSpeedValue = speedValue;   // Save current speed
      speedValue = 0;
    } else if (lastSpeedValue > 0) {
      speedValue = lastSpeedValue;   // Restore last speed
    }
    encoder.setCount(speedValue);
    updateMotor();
    updateDisplay = true;
    delay(200); // debounce
  }
  lastButtonState = buttonState;
  if (count != lastCount) {
    speedValue = constrain(count, 0, 255);
    encoder.setCount(speedValue);
    lastCount = speedValue;
    updateMotor();
    updateDisplay = true;
  }
  
  // Update OLED display
  if (updateDisplay) {
    updateOLED();
    updateDisplay = false;
  }
  
  delay(10);
}
